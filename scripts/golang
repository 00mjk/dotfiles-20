#!/usr/bin/env bash

set -e

# --------------------------------------------------------------------------- #
# --- Detect the operating system ------------------------------------------- #
# --------------------------------------------------------------------------- #

PLATFORM=
if [[ "$(uname -s)" =~ Darwin ]]; then
  PLATFORM='darwin'
elif [[ "$(uname -s)" =~ Linux ]]; then
  PLATFORM='linux'
else
  echo "Unsupported platform: $(uname -s)"
  exit 1
fi

# --------------------------------------------------------------------------- #
# --- Detect processor architecture ----------------------------------------- #
# --------------------------------------------------------------------------- #

ARCH="$(uname -m)"
GO_ARCH=
if [[ $ARCH == "x86_64" ]]; then
  GO_ARCH='amd64'
elif [[ $ARCH == "arm64" || $ARCH == "aarch64" ]]; then
  GO_ARCH='arm64'
else
  echo "Unsupported architecture: $(uname -m)"
  exit 1
fi

# --------------------------------------------------------------------------- #
# --- Parse params ---------------------------------------------------------- #
# --------------------------------------------------------------------------- #

PARAMS=""
TRUE=true
LOCAL_INSTALL="false"
while [[ "$#" != "0" ]]; do
  case "$1" in
    -l|--local)
      LOCAL_INSTALL="$TRUE"
      shift
      ;;
    -*|--*=) # unsupported flags
      echo "Error: Unknown flag $1" >&2
      exit 1
      ;;
    *) # preserve positional arguments
      PARAMS="$PARAMS $1"
      shift
      ;;
  esac
done
# set positional arguments in their proper place
eval set -- "$PARAMS"

# --------------------------------------------------------------------------- #
# --- Go version (given or latest) ------------------------------------------ #
# --------------------------------------------------------------------------- #

GO_VERSION=$1

# If no version was specified use the latest available
if [[ -z "$GO_VERSION" ]]; then
  # The Golang project does not use github releases properly (2021-05-14).
  # The most reliable way is currently to parse the official Golang downloads page.
  GO_VERSION=$(
    curl -gsL golang.org/dl \
      | grep -m1 "${PLATFORM}-${GO_ARCH}.tar.gz" \
      | sed -E "s|.*\"/dl/go(.+)\.${PLATFORM}-${GO_ARCH}.tar.gz\".+|\1|"
  )
fi

# --------------------------------------------------------------------------- #
# --- Finalise config ------------------------------------------------------- #
# --------------------------------------------------------------------------- #

CURRDIR="$(cd "$(dirname "$([ -L "${0}" ] && readlink "${0}" || echo "${0}")")" && pwd -P)"

GO_ROOT=
if [[ "${LOCAL_INSTALL}" == "$TRUE" ]]; then
  GO_ROOT="${HOME}/.go/${GO_VERSION}"
else
  GO_ROOT="/usr/local/go"
fi
DOWNLOAD_DIR="${HOME}/Downloads"
FILENAME="go${GO_VERSION}.${PLATFORM}-${GO_ARCH}.tar.gz"
ARCHIVE_FILE="${DOWNLOAD_DIR}/${FILENAME}"
URL="https://golang.org/dl/${FILENAME}"

cat <<-EOF
PLATFORM ....... ${PLATFORM}
ARCH ........... ${ARCH}
GO_ARCH ........ ${GO_ARCH}
GO_VERSION ..... ${GO_VERSION}
GO_ROOT ........ ${GO_ROOT}
FILENAME ....... ${FILENAME}
DOWNLOAD_DIR ... ${DOWNLOAD_DIR}
ARCHIVE_FILE ... ${ARCHIVE_FILE}
URL ............ ${URL}
LOCAL_INSTALL .. ${LOCAL_INSTALL}
EOF

# --------------------------------------------------------------------------- #
# --- Perform installation -------------------------------------------------- #
# --------------------------------------------------------------------------- #

ALREDY_INSTALLED_MSG="
Desired version is already installed at ${GO_ROOT}, nothing to do
"

if [[ "${LOCAL_INSTALL}" == "true" &&  -d "${GO_ROOT}" ]]; then
  echo "${ALREDY_INSTALLED_MSG}"
  exit 0
fi

if test -x $GO_ROOT/bin/go && $GO_ROOT/bin/go version | grep "${GO_VERSION}"; then
  echo "${ALREDY_INSTALLED_MSG}"
  exit 0
fi

echo "Downloading ${URL}"
curl \
  "${URL}" \
  --location \
  --create-dirs \
  --time-cond "${ARCHIVE_FILE}" \
  --fail-with-body \
  --output "${ARCHIVE_FILE}"

# Remove old installation only if it's a global install. Local installs would
# not reach this point, the scripts exits above if a folder for the local
# version is already present.
if [[ ! "${LOCAL_INSTALL}" == "true" ]]; then
  echo "Running command with sudo to remove previous global installation"
  sudo \rm -rf "${GO_ROOT}"
fi

echo "Extract ${ARCHIVE_FILE} -> ${GO_ROOT}"
if [[ "${LOCAL_INSTALL}" == "true" ]]; then
  mkdir -p "${GO_ROOT}"
  tar --directory "${GO_ROOT}" --strip-components=1 -xzf "${ARCHIVE_FILE}"
else
  echo "Running command with sudo to perform global installation"
  sudo mkdir -p "${GO_ROOT}"
  sudo tar --directory "${GO_ROOT}" --strip-components=1 -xzf "${ARCHIVE_FILE}"
fi

echo "Checking installation: $($GO_ROOT/bin/go version) installed at $GO_ROOT/bin/go"
